<script>
    function uploadFile() {
        let fileInput = document.getElementById("fileInput").files[0];
        if (!fileInput) { alert("No file selected."); return; }
        let formData = new FormData();
        formData.append("file", fileInput);

        fetch("/upload", { method: "POST", body: formData })
            .then(response => response.json())
            .then(data => { 
                console.log("Upload response:", data);  // ✅ Debugging log
                alert(data.status === 'completed' ? "Upload Successful!" : "Upload Failed!"); 
                startProcessing();
            })
            .catch(error => console.error("❌ Upload Error:", error));
    }

    function startProcessing() {
        let venueAddress = prompt("Enter venue address:");
        if (!venueAddress) { alert("No address provided."); return; }

        document.querySelector(".progress-container").style.display = "block";

        fetch("/generate_polygons", { 
            method: "POST", 
            headers: { "Content-Type": "application/json" }, 
            body: JSON.stringify({ venue_address: venueAddress }) 
        })
        .then(response => response.json())
        .then(data => { 
            console.log("Processing response:", data);  // ✅ Debugging log
            if (data.status === "completed") {
                updateProgress();
            } else {
                alert("❌ Error generating polygons: " + data.message);
            }
        })
        .catch(error => console.error("❌ Processing Error:", error));
    }

    function updateProgress() {
        const progressBar = document.getElementById("progressBar");

        function checkProgress() {
            fetch("/progress")
                .then(response => response.json())
                .then(data => {
                    console.log("Progress:", data.progress);  // ✅ Debugging log
                    progressBar.style.width = data.progress + "%";
                    progressBar.innerText = data.progress + "%";

                    if (data.progress < 100) {
                        setTimeout(checkProgress, 1000);
                    } else {
                        alert("✅ Processing Complete! Click 'Download GeoJSON'");
                        document.getElementById("downloadButton").style.display = "block";
                    }
                })
                .catch(error => console.error("❌ Progress Error:", error));
        }
        checkProgress();
    }
</script>
